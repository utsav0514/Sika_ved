{% extends 'base.html' %}
{% load static %}
{% block content %}

<style>
    .reports-container {
        padding: 30px 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .page-title {
        font-size: 32px;
        font-weight: 800;
        color: #2d6a8a;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .header-buttons {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, #2d6a8a 0%, #7ba885 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        color: white;
    }

    .dashboard-btn {
        background: linear-gradient(135deg, #36A2EB 0%, #2196F3 100%);
    }

    .chart-grid {
        display: grid;
        grid-template-areas: 
            "weekly monthly"
            "annual category";
        grid-template-columns: 1fr 1fr;
        gap: 25px;
        margin-bottom: 30px;
    }

    .weekly-chart {
        grid-area: weekly;
    }

    .monthly-chart {
        grid-area: monthly;
    }

    .annual-chart {
        grid-area: annual;
    }

    .category-chart {
        grid-area: category;
    }

    .chart-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .chart-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .chart-title {
        font-size: 18px;
        font-weight: 700;
        color: #2d6a8a;
        margin: 0;
    }

    .filter-select {
        padding: 8px 16px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 13px;
        color: #333;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 150px;
    }

    .filter-select:focus {
        outline: none;
        border-color: #2d6a8a;
        box-shadow: 0 0 0 3px rgba(45, 106, 138, 0.1);
    }

    .summary-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
    }

    .summary-title {
        font-size: 20px;
        font-weight: 700;
        color: #2d6a8a;
        margin-bottom: 20px;
    }

    .summary-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .summary-table thead {
        background: linear-gradient(135deg, #2d6a8a 0%, #7ba885 100%);
        color: white;
    }

    .summary-table th {
        padding: 15px;
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-align: left;
    }

    .summary-table th:first-child {
        border-radius: 10px 0 0 0;
    }

    .summary-table th:last-child {
        border-radius: 0 10px 0 0;
    }

    .summary-table td {
        padding: 15px;
        font-size: 14px;
        color: #555;
        border-bottom: 1px solid #f0f0f0;
    }

    .summary-table tbody tr:hover {
        background: #f8f9fa;
    }

    .summary-table tbody tr:last-child td:first-child {
        border-radius: 0 0 0 10px;
    }

    .summary-table tbody tr:last-child td:last-child {
        border-radius: 0 0 10px 0;
    }

    .amount-cell {
        font-weight: 600;
        font-family: monospace;
    }

    .expense-amount {
        color: #e74c3c;
    }

    .income-amount {
        color: #2ecc71;
    }

    @media (max-width: 1200px) {
        .chart-grid {
            grid-template-areas: 
                "weekly"
                "monthly"
                "annual"
                "category";
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .header-section {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }

        .page-title {
            font-size: 28px;
        }
    }
</style>

<div class="reports-container">

    <!-- Header Section -->
    <div class="header-section">
        <h1 class="page-title">üìä Financial Reports & Analytics</h1>
        <div class="header-buttons">
            <a href="{% url 'dashboard' %}" class="btn dashboard-btn">
                <i class="fas fa-chart-line"></i> Dashboard
            </a>
            <a href="{% url 'reports_pdf' %}" class="btn">
                <i class="fas fa-file-pdf"></i> Download PDF Report
            </a>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="chart-grid">

        <!-- Weekly Chart -->
        <div class="chart-card weekly-chart">
            <div class="chart-header">
                <h5 class="chart-title">üìà Weekly Trends</h5>
                <select id="weeklyMonthFilter" class="filter-select">
                    <option value="">All Months</option>
                    {% for m in all_months %}
                    <option value="{{ m|date:'Y-m' }}" {% if selected_weekly_month == m|date:'Y-m' %}selected{% endif %}>
                        {{ m|date:"F Y" }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <canvas id="weeklyChart"></canvas>
        </div>

        <!-- Monthly Chart -->
        <div class="chart-card monthly-chart">
            <div class="chart-header">
                <h5 class="chart-title">üìä Monthly Analysis</h5>
                <select id="monthlyYearFilter" class="filter-select">
                    <option value="">All Years</option>
                    {% for y in all_years %}
                    <option value="{{ y|date:'Y' }}" {% if selected_monthly_year == y|date:'Y' %}selected{% endif %}>
                        {{ y|date:"Y" }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <canvas id="monthlyChart"></canvas>
        </div>

        <!-- Yearly Chart -->
        <div class="chart-card annual-chart">
            <div class="chart-header">
                <h5 class="chart-title">üìÖ Annual Overview</h5>
            </div>
            <canvas id="yearlyChart"></canvas>
        </div>

        <!-- Category Chart -->
        <div class="chart-card category-chart">
            <div class="chart-header">
                <h5 class="chart-title">üè∑Ô∏è Expense Categories</h5>
                <select id="categoryMonthFilter" class="filter-select">
                    <option value="">All Months</option>
                    {% for m in all_months %}
                    <option value="{{ m|date:'Y-m' }}" {% if selected_category_month == m|date:'Y-m' %}selected{% endif %}>
                        {{ m|date:"F Y" }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <canvas id="categoryChart"></canvas>
        </div>

    </div>

    <!-- Summary Tables Section -->
    <div class="summary-section">
        <h3 class="summary-title">üìä Weekly Summary</h3>
        <div class="table-responsive">
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Week</th>
                        <th>Expenses</th>
                        <th>Incomes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in weekly_summary %}
                    <tr>
                        <td>{{ item.period }}</td>
                        <td class="amount-cell expense-amount">‚Çπ{{ item.expenses }}</td>
                        <td class="amount-cell income-amount">‚Çπ{{ item.incomes }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-center">No data available</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="summary-section">
        <h3 class="summary-title">üìÖ Monthly Summary</h3>
        <div class="table-responsive">
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Expenses</th>
                        <th>Incomes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in monthly_summary %}
                    <tr>
                        <td>{{ item.period }}</td>
                        <td class="amount-cell expense-amount">‚Çπ{{ item.expenses }}</td>
                        <td class="amount-cell income-amount">‚Çπ{{ item.incomes }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-center">No data available</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="summary-section">
        <h3 class="summary-title">üìà Annual Summary</h3>
        <div class="table-responsive">
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Expenses</th>
                        <th>Incomes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in yearly_summary %}
                    <tr>
                        <td>{{ item.period }}</td>
                        <td class="amount-cell expense-amount">‚Çπ{{ item.expenses }}</td>
                        <td class="amount-cell income-amount">‚Çπ{{ item.incomes }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-center">No data available</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="summary-section">
        <h3 class="summary-title">üè∑Ô∏è Category Breakdown</h3>
        <div class="table-responsive">
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Total Expenses</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in expense_category %}
                    <tr>
                        <td>{{ c.category__name }}</td>
                        <td class="amount-cell expense-amount">‚Çπ{{ c.total }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="2" class="text-center">No data available</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    </div>
</div>

<!-- ===================== CHART.JS ===================== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const weeklySummary = JSON.parse('{{ weekly_summary_json|escapejs }}');
    const monthlySummary = JSON.parse('{{ monthly_summary_json|escapejs }}');
    const yearlySummary = JSON.parse('{{ yearly_summary_json|escapejs }}');
    const expenseCategory = JSON.parse('{{ expense_category_json|escapejs }}');

    const chartOptions = {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    usePointStyle: true,
                    padding: 20,
                    font: {
                        size: 12,
                        weight: '600'
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: {
                    size: 14,
                    weight: '600'
                },
                bodyFont: {
                    size: 13
                },
                cornerRadius: 8
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    font: {
                        size: 12
                    }
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    font: {
                        size: 12
                    }
                }
            }
        }
    };

    const createDataset = (label, data, color, type='bar') => ({
        label,
        data,
        backgroundColor: type === 'bar' ? color : 'rgba(255, 255, 255, 0.8)',
        borderColor: color,
        borderWidth: type === 'bar' ? 0 : 2,
        fill: type !== 'bar' ? true : undefined,
        tension: 0.4,
        pointRadius: 4,
        pointHoverRadius: 6,
        pointBackgroundColor: color,
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointHoverBorderWidth: 2,
        pointHoverBackgroundColor: color,
        pointHoverBorderColor: '#fff'
    });

    // WEEKLY
    new Chart(document.getElementById('weeklyChart'), {
        type: 'line',
        data: {
            labels: weeklySummary.map(w => w.period),
            datasets: [
                createDataset('Expenses', weeklySummary.map(w => w.expenses), '#e74c3c', 'line'),
                createDataset('Incomes', weeklySummary.map(w => w.incomes), '#2ecc71', 'line')
            ]
        },
        options: {
            ...chartOptions,
            plugins: {
                ...chartOptions.plugins,
                subtitle: {
                    display: true,
                    text: 'Weekly income vs expense trends',
                    padding: {
                        bottom: 20
                    }
                }
            }
        }
    });

    // MONTHLY
    new Chart(document.getElementById('monthlyChart'), {
        type: 'bar',
        data: {
            labels: monthlySummary.map(m => m.period),
            datasets: [
                createDataset('Expenses', monthlySummary.map(m => m.expenses), 'rgba(231, 76, 60, 0.8)'),
                createDataset('Incomes', monthlySummary.map(m => m.incomes), 'rgba(46, 204, 113, 0.8)')
            ]
        },
        options: {
            ...chartOptions,
            plugins: {
                ...chartOptions.plugins,
                subtitle: {
                    display: true,
                    text: 'Monthly financial overview',
                    padding: {
                        bottom: 20
                    }
                }
            }
        }
    });

    // YEARLY
    new Chart(document.getElementById('yearlyChart'), {
        type: 'bar',
        data: {
            labels: yearlySummary.map(y => y.period),
            datasets: [
                createDataset('Expenses', yearlySummary.map(y => y.expenses), 'rgba(231, 76, 60, 0.8)'),
                createDataset('Incomes', yearlySummary.map(y => y.incomes), 'rgba(46, 204, 113, 0.8)')
            ]
        },
        options: {
            ...chartOptions,
            plugins: {
                ...chartOptions.plugins,
                subtitle: {
                    display: true,
                    text: 'Yearly financial summary',
                    padding: {
                        bottom: 20
                    }
                }
            }
        }
    });

    // CATEGORY
    new Chart(document.getElementById('categoryChart'), {
        type: 'doughnut',
        data: {
            labels: expenseCategory.map(c => c.category__name),
            datasets: [{
                data: expenseCategory.map(c => c.total),
                backgroundColor: [
                    'rgba(231, 76, 60, 0.8)',
                    'rgba(46, 204, 113, 0.8)',
                    'rgba(52, 152, 219, 0.8)',
                    'rgba(155, 89, 182, 0.8)',
                    'rgba(241, 196, 15, 0.8)',
                    'rgba(230, 126, 34, 0.8)'
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            size: 12,
                            weight: '600'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14,
                        weight: '600'
                    },
                    bodyFont: {
                        size: 13
                    },
                    cornerRadius: 8
                }
            }
        }
    });

    // ================= FILTER JS =================
    document.getElementById('weeklyMonthFilter').addEventListener('change', function(){
        const month = this.value;
        const url = new URL(window.location.href);
        if(month) url.searchParams.set('weekly_month', month);
        else url.searchParams.delete('weekly_month');
        window.location.href = url.toString();
    });

    document.getElementById('monthlyYearFilter').addEventListener('change', function(){
        const year = this.value;
        const url = new URL(window.location.href);
        if(year) url.searchParams.set('monthly_year', year);
        else url.searchParams.delete('monthly_year');
        window.location.href = url.toString();
    });

    document.getElementById('categoryMonthFilter').addEventListener('change', function(){
        const month = this.value;
        const url = new URL(window.location.href);
        if(month) url.searchParams.set('category_month', month);
        else url.searchParams.delete('category_month');
        window.location.href = url.toString();
    });
</script>

{% endblock %}

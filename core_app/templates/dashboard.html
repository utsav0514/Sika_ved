{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Dashboard</h2>
        <div>
            <a href="{% url 'add_expense' %}" class="btn btn-success">Add Expense</a>
            <a href="{% url 'reports' %}" class="btn btn-info">View Reports</a>
            <a href="{% url 'reports_pdf' %}" class="btn btn-primary">Download PDF</a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3">
                <div class="card-header">Today's Expenses</div>
                <div class="card-body">
                    <h5 class="card-title">₹{{ today_total }}</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-secondary mb-3">
                <div class="card-header">Last Week</div>
                <div class="card-body">
                    <h5 class="card-title">₹{{ last_week_total }}</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info mb-3">
                <div class="card-header">This Month</div>
                <div class="card-body">
                    <h5 class="card-title">₹{{ this_month_total }}</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-dark mb-3">
                <div class="card-header">Last Month</div>
                <div class="card-body">
                    <h5 class="card-title">₹{{ last_month_total }}</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Weekly Difference -->
    <div class="card text-white {% if weekly_difference > 0 %}bg-danger{% elif weekly_difference < 0 %}bg-success{% else %}bg-dark{% endif %} mb-3">
        <div class="card-header">Weekly Difference</div>
        <div class="card-body">
            {% if weekly_difference > 0 %}
                <h5 class="card-title">You spent ₹{{ weekly_difference_abs }} more than last week.</h5>
            {% elif weekly_difference < 0 %}
                <h5 class="card-title">You spent ₹{{ weekly_difference_abs }} less than last week.</h5>
            {% else %}
                <h5 class="card-title">Your spending is the same as last week.</h5>
            {% endif %}
        </div>
    </div>

    <!-- Category Summary -->
    <h4>Expenses by Category</h4>
    <ul>
        {% for c in category_summary %}
            <li>{{ c.category__name }}: ₹{{ c.total }}</li>
        {% endfor %}
    </ul>

    <!-- Category Pie Chart -->
    <canvas id="categoryChart"></canvas>

    <!-- Monthly Expenses Chart -->
    <h4 class="mt-4">Monthly Expenses</h4>
    <canvas id="monthlyChart"></canvas>

    <!-- Recent Expenses Table -->
    <h4 class="mt-4">Recent Expenses</h4>
    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                <th>Date</th>
                <th>Category</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for exp in expenses|slice:":5" %}
            <tr>
                <td>{{ exp.date }}</td>
                <td>{{ exp.category.name }}</td>
                <td>{{ exp.description }}</td>
                <td>₹{{ exp.amount }}</td>
                <td>
                    <a href="{% url 'edit_expense' exp.id %}" class="btn btn-sm btn-warning">Edit</a>
                    <a href="{% url 'delete_expense' exp.id %}" class="btn btn-sm btn-danger" 
                       onclick="return confirm('Are you sure you want to delete this expense?');">Delete</a>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="5" class="text-center">No expenses yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Category Pie Chart
    var ctx1 = document.getElementById('categoryChart').getContext('2d');
    var categoryChart = new Chart(ctx1, {
        type: 'pie',
        data: {
            labels: [{% for c in category_summary %}'{{ c.category__name }}',{% endfor %}],
            datasets: [{
                data: [{% for c in category_summary %}{{ c.total }},{% endfor %}],
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' },
                title: { display: true, text: 'Expenses by Category' }
            }
        }
    });

    // Monthly Bar Chart
    var ctx2 = document.getElementById('monthlyChart').getContext('2d');
    var monthlyChart = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: [{% for m in monthly_summary %}'{{ m.month|date:"M Y" }}',{% endfor %}],
            datasets: [{
                label: 'Monthly Expenses',
                data: [{% for m in monthly_summary %}{{ m.total }},{% endfor %}],
                backgroundColor: '#36A2EB'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Monthly Expenses' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>

<style>
canvas { max-width: 600px; margin: 20px auto; display: block; }
table { margin-top: 20px; }
.card { text-align: center; }
.card .card-title { font-size: 1.5rem; }
</style>

{% endblock %}
